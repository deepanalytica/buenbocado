// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  category    String    // "pouch" | "pack"
  status      String    @default("active") // "active" | "draft"
  
  heroImage   String?
  galleryImages String    @default("")
  badges        String    @default("")
  
  seoTitle       String?
  seoDescription String?
  
  variants Variant[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([category, status])
  @@index([slug])
}

model Flavor {
  id        String @id @default(cuid())
  name      String @unique
  slug      String @unique
  colorHex  String
  fruitAssets String    @default("")
  notes     String?
  sortOrder Int    @default(0)
  
  variants Variant[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([sortOrder])
}

model Variant {
  id         String  @id @default(cuid())
  productId  String
  flavorId   String
  weight     Int     // 90 or 120 (grams)
  sku        String  @unique
  
  price           Float
  compareAtPrice  Float?
  stock           Int?
  
  // Claim toggles (defaults to false)
  claimSinSellos       Boolean @default(false)
  claimSinAzucar       Boolean @default(false)
  claimIngredientesSimples Boolean @default(false)
  
  product  Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  flavor   Flavor  @relation(fields: [flavorId], references: [id])
  
  orderItems OrderItem[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([productId])
  @@index([flavorId])
  @@index([sku])
}

model Pack {
  id      String  @id @default(cuid())
  name    String
  slug    String  @unique
  size    Int     // total items (10, 20, 6)
  price   Float
  enabled Boolean @default(true)
  
  // Rules stored as JSON
  minPerFlavor Int @default(1)
  maxPerFlavor Int @default(5)
  
  description String?
  image       String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id String @id @default(cuid())
  
  // Customer info
  customerName  String
  customerEmail String
  customerPhone String
  
  // Shipping address
  address       String
  addressNumber String
  commune       String
  region        String
  postalCode    String?
  deliveryNotes String?
  
  // Totals
  subtotal       Float
  discount       Float   @default(0)
  shippingCost   Float
  total          Float
  
  // Coupon used
  couponCode String?
  
  // Status
  paymentStatus String @default("pending") // "pending" | "paid" | "failed"
  orderStatus   String @default("pending") // "pending" | "processing" | "shipped" | "delivered" | "cancelled"
  
  // Payment method
  paymentMethod String @default("bank_transfer") // "bank_transfer" | others
  
  // Tracking
  trackingNumber String?
  
  items OrderItem[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([customerEmail])
  @@index([orderStatus])
  @@index([createdAt])
}

model OrderItem {
  id String @id @default(cuid())
  
  orderId   String
  variantId String
  
  quantity Int
  price    Float  // Price at time of order
  
  // Snapshot data (in case variant is deleted)
  productName String
  flavorName  String
  weight      Int
  
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant Variant @relation(fields: [variantId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@index([orderId])
  @@index([variantId])
}

model Coupon {
  id      String  @id @default(cuid())
  code    String  @unique
  type    String  // "percentage" | "fixed"
  value   Float
  expiry  DateTime?
  enabled Boolean @default(true)
  
  usageCount Int @default(0)
  maxUsage   Int?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([code])
}

model ShippingRate {
  id         String  @id @default(cuid())
  regionName String
  price      Float
  etaText    String  // e.g., "3-5 días hábiles"
  enabled    Boolean @default(true)
  sortOrder  Int     @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([enabled, sortOrder])
}

model ContentBlock {
  id         String  @id @default(cuid())
  page       String  // "faq" | "about" | "terms" | etc
  sectionKey String  // unique identifier for this content piece
  title      String
  body       String
  enabled    Boolean @default(true)
  sortOrder  Int     @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([page, sectionKey])
  @@index([page, enabled, sortOrder])
}

model User {
  id       String @id @default(cuid())
  email    String @unique
  password String // Hashed
  name     String
  role     String @default("admin") // "admin" | "editor"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([email])
}

model B2BLead {
  id String @id @default(cuid())
  
  businessName    String
  contactName     String
  email           String
  phone           String
  businessType    String  // "school" | "kiosk" | "minimarket"
  estimatedVolume String?
  message         String?
  status          String  @default("new") // "new" | "contacted" | "converted"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([status, createdAt])
}
